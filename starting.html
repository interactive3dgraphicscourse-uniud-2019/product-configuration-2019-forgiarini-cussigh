<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>Document</title>
  <link type="text/css" rel="stylesheet" href="styles/editor.css">
  <link type="text/css" rel="stylesheet" href="styles/main.css">
  <script src="lib/three.js"></script>
  <script src="lib/stats.min.js"></script>
  <script src="lib/Coordinates.js"></script>
  <script src="lib/OrbitControls.js"></script>
  <script src="lib/tmpl.js"></script>
  <script src="scripts/utils.js"></script>
  <script src="scripts/globalVariables.js"></script>
  <script src='lib/LoaderSupport.js'></script>
  <script src='lib/OBJLoader.js'></script>
  <script src='lib/OBJLoader2.js'></script> 
  <script src='lib/BufferGeometryUtils.js'></script>
  <script src="scripts/lights2.js"></script>
  <script src="scripts/EditorPartController.js"></script>
  <script src="scripts/main2.js"></script>
</head>

<body onload="init()">
  <div class="options-container">
    <div id="editorOptions" class="options">
    </div>
  </div>
  <div style="display: none">

    <!-- Shaders -->
    <script type="text/x-glsl" id="vertex">
        varying vec3 vNormal;
        varying vec3 vPosition;
        varying vec2 uVv;
        attribute vec4 tangent;
        varying vec3 vTangent;
        varying vec3 vBitangent;
    
        void main() {
          vec4 vPos = modelViewMatrix * vec4( position, 1.0 );
          vPosition = vPos.xyz;
          vNormal = normalize(normalMatrix * normal);
    
          vec3 objectTangent = vec3( tangent.xyz );
          vec3 transformedTangent = normalMatrix * objectTangent;
          vTangent = normalize( transformedTangent );
          vBitangent = normalize( cross( vNormal, vTangent ) * tangent.w );
    
    
          uVv = uv;
          gl_Position = projectionMatrix * vPos;
        }
        </script>

    <script type="text/x-glsl" id="fragment">

          varying vec3 vTangent;
          varying vec3 vBitangent;
    
          varying vec3 vNormal;
          varying vec3 vPosition;
          varying vec2 uVv;
          uniform vec3 pointLightPosition1; // in world space
          uniform vec3 pointLightPosition2; // in world space
          uniform vec3 clight1; 
          uniform vec3 clight2; 
          uniform sampler2D specularMap;
          uniform sampler2D diffuseMap;
          uniform sampler2D roughnessMap;
          uniform sampler2D normalMap;
          uniform vec2 textureRepeat;
          const float PI = 3.14159;
          
          uniform vec2 normalScale;
          
          const int numberOfLights = 2;
          vec3 lights[numberOfLights];
          vec3 clights[numberOfLights];
    
          vec3 cdiff;
          vec3 cspec;
          float roughness;
    
          vec3 FSchlick(float lDoth) {
            return (cspec + (vec3(1.0)-cspec)*pow(1.0 - lDoth,5.0));
          }
    
          float DGGX(float nDoth, float alpha) {
            float alpha2 = alpha*alpha;
            float d = nDoth*nDoth*(alpha2-1.0)+1.0;
            return (  alpha2 / (PI*d*d));
          }
    
          float G1(float dotProduct, float k) {
            return (dotProduct / (dotProduct*(1.0-k) + k) );
          }
    
          float GSmith(float nDotv, float nDotl) {
              float k = roughness*roughness;
              return G1(nDotl,k)*G1(nDotv,k);
          }
    
          void main() {
            vec3 outRadiance = vec3(0,0,0);
            lights[0] = pointLightPosition1;
            lights[1] = pointLightPosition2;
            clights[0] = clight1;
            clights[1] = clight2;
    
            for (int i=0; i<numberOfLights; i++)
            {
            vec4 lPosition = viewMatrix * vec4( lights[i], 1.0 );
            vec3 l = normalize(lPosition.xyz - vPosition.xyz);
            vec3 v = normalize( -vPosition);
            vec3 h = normalize( v + l);
    
            
            vec3 normal = normalize( vNormal );
            vec3 tangent = normalize( vTangent );
            vec3 bitangent = normalize( vBitangent );
            mat3 vTBN = mat3( tangent, bitangent, normal );
            vec3 mapN = texture2D( normalMap, uVv ).xyz * 2.0 - 1.0;
            mapN.xy = normalScale * mapN.xy;
            vec3 n = normalize( vTBN * mapN );
    
            
            // small quantity to prevent divisions by 0
            float nDotl = max(dot( n, l ),0.000001);
            float lDoth = max(dot( l, h ),0.000001);
            float nDoth = max(dot( n, h ),0.000001);
            float vDoth = max(dot( v, h ),0.000001);
            float nDotv = max(dot( n, v ),0.000001);
    
            cdiff = texture2D( diffuseMap, uVv*textureRepeat ).rgb;
            // texture in sRGB, linearize
            cdiff = pow( cdiff, vec3(2.2));
            cspec = texture2D( specularMap, uVv*textureRepeat ).rgb;
            // texture in sRGB, linearize
            cspec = pow( cspec, vec3(2.2));
            roughness = texture2D( roughnessMap, uVv*textureRepeat).r; // no need to linearize roughness map
    
            vec3 fresnel = FSchlick(lDoth);
            vec3 BRDF = (vec3(1.0)-fresnel)*cdiff/PI + fresnel*GSmith(nDotv,nDotl)*DGGX(nDoth,roughness*roughness)/
              (4.0*nDotl*nDotv);
            outRadiance = outRadiance + PI* clights[i] * nDotl * BRDF;
            // gamma encode the final value
            }
            gl_FragColor = vec4(pow( outRadiance, vec3(1.0/2.2)), 1.0);
          }
        </script>

    <!-- templates used to create options menu -->
    <script type="text/x-tmpl" id="tmpl-insert-part-wrapper">
        <div class="part" data-part="{%=part.name_id%}">
          <div class="part-name">{%=part.name%}</div>
          <div class="avaiable-materials">
              <p>Materiale</p>
              <select class="select-texture-material"></select>
          </div>
          <div class="available-colors">
              <p>Colore</p>
          </div>
          <div class="slidercontainer">
              <input type="range" step="{%=part.stepSlider%}" min="{%=part.minValSlider%}" max="{%=part.maxValSlider%}" value="{%=part.startValSlider%}" class="slider"/>
          </div>
      </div>
      </script>

    <script type="text/x-tmpl" id="tmpl-insert-texture-type-wrapper">
        <div class="available-textures hide" data-texture-type="{%=texture.type_name%}"></div>
      </script>

    <script type="text/x-tmpl" id="tmpl-insert-texture-icon-wrapper">
        <div class="texture-icon-wrapper" data-icon-id="{%=texture_info.id%}">
          <img class="texture-icon" src="{%=texture_info.url%}" alt="{%=texture_info.id%} icon" />
        </div>
      </script>

    <script type="text/x-tmpl" id="tmpl-option-texture-type">
        <option value="{%=texture.type_name%}">{%=texture.type%}</option>
      </script>
  </div>
</body>

</html>